version: '3.5'
services:
  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    expose:
      - 9092
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_CREATE_TOPICS: "bc-trn-event-dev:1:1,bc-trn-event-demo:1:1,bc-trn-csv-dev:1:1,bc-trn-csv-demo:1:1,bc-price-dev:1:1,bc-price-demo:1:1,bc-ca-event-demo:1:1,bc-ca-event-dev:1:1"
      KAFKA_LISTENERS: "BC-DEMO://${KAKFA_HOST_NAME:-kafka}:9092"
      KAFKA_ADVERTISED_LISTENERS: "BC-DEMO://${KAKFA_HOST_NAME:-kafka}:9092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: BC-DEMO:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: BC-DEMO
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
    depends_on:
      - zookeeper

  postgres:
    image: postgres:12-alpine
    container_name: postgres
    expose:
      - 5432
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: "${PG_USER:-postgres}"
      POSTGRES_PASSWORD: "${PG_PASSWORD:-password}"
      POSTGRES_MULTIPLE_DATABASES: bc,ev
    volumes:
      - pg-data:/var/lib/backup/data
      - ./postgres:/docker-entrypoint-initdb.d

  data:
    image: monowai/bc-data
    container_name: data
    expose:
      - 9510
      - 9511
    # Ports should be published if you are running local:bc-view against this stack
    ports:
      - "9610:9510"
      - "9611:9511"
    environment:
      SERVER_PORT: 9510
      MANAGEMENT_SERVER_PORT: 9511

      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/bc
      # https://docs.docker.com/compose/environment-variables/
      SPRING_DATASOURCE_USERNAME: "${PG_USER:-postgres}"
      SPRING_DATASOURCE_PASSWORD: "${PG_PASSWORD:-password}"
      BEANCOUNTER_MARKET_PROVIDERS_FX_KEY: ${FX}
      BEANCOUNTER_MARKET_PROVIDERS_FIGI_KEY: ${FIGI}
      BEANCOUNTER_MARKET_PROVIDERS_FIGI_ENABLED: "true"
      BEANCOUNTER_MARKET_PROVIDERS_WTD_KEY: ${WTD}
      BEANCOUNTER_MARKET_PROVIDERS_WTD_MARKETS:
      BEANCOUNTER_MARKET_PROVIDERS_ALPHA_KEY: ${ALPHA}
      BEANCOUNTER_MARKET_PROVIDERS_ALPHA_MARKETS: NASDAQ,AMEX,NYSE,ASX,NZX,LON
      BEANCOUNTER_TOPICS_TRN_CSV: bc-trn-csv-demo
      BEANCOUNTER_TOPICS_TRN_EVENT: bc-trn-event-demo
      BEANCOUNTER_TOPICS_CA_EVENT: bc-ca-event-demo
      BEANCOUNTER_ZONE: "Asia/Singapore"
      ASSETS_SCHEDULE: "0 0/30 5-7 * * Tue-Sat"

      KAFKA_ENABLED: "true"
      AUTH_URI: ${AUTH_URI}
      AUTH_AUDIENCE: ${AUTH_AUDIENCE}
    depends_on:
      - postgres

  position:
    image: monowai/bc-position
    container_name: position
    expose:
      - 9500
      - 9501
    # Publish this if you are running local:bc-view against docker services
    ports:
      - "9600:9500"
      - "9601:9501"

    environment:
      SERVER_PORT: 9500
      MANAGEMENT_SERVER_PORT: 9501

      MARKETDATA_URL: "http://data:9510/api"
      AUTH_URI: ${AUTH_URI}
      AUTH_AUDIENCE: ${AUTH_AUDIENCE}
    depends_on:
      - data

  event:
    image: monowai/bc-event
    container_name: event
    expose:
      - 9520
    # Ports should be published if you are running local:bc-view against this stack
    ports:
      - "9630:9520"
    environment:
      SERVER_PORT: 9520
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/ev
      SPRING_DATASOURCE_USERNAME: "${PG_USER:-postgres}"
      SPRING_DATASOURCE_PASSWORD: "${PG_PASSWORD:-password}"
      SPRING_JPA_HIBERNATE_DDL-AUTO: "update"
      MARKETDATA_URL: "http://data:9510/api"
      POSITION_URL: "http://position:9500/api"
      KAFKA_ENABLED: "true"
      AUTH_URI: ${AUTH_URI}
      AUTH_AUDIENCE: ${AUTH_AUDIENCE}
      AUTH_CLIENT_ID: ${AUTH_CLIENT_ID}
      AUTH_CLIENT_SECRET: "${AUTH_CLIENT_SECRET}"
      BEANCOUNTER_ZONE: "Asia/Singapore"
      EVENTS_SCHEDULE: "0 0/15 6-9 * * Tue-Sat"
      BEANCOUNTER_TOPICS_CA_EVENT: bc-ca-event-demo
      BEANCOUNTER_TOPICS_TRN_EVENT: bc-trn-event-demo
      #SPRING_SECURITY_OAUTH2_REGISTRATION_CUSTOM_CLIENT-SECRET: "${BC_M2M:-notset}"

    depends_on:
      - data
      - position

  view:
    image: monowai/bc-view
    ports:
      - "4000:3000"

    container_name: view
    environment:
      SVC_POSITION: "http://position:9500"
      SVC_DATA: "http://data:9510"
      KAFKA_URL: "kafka:9092"
      KAFKA_TOPIC_TRN: "bc-trn-csv-demo"
      AUTH0_ISSUER_BASE_URL: "${AUTH_URI}"
      AUTH0_AUDIENCE: "${AUTH_AUDIENCE}"
      AUTH0_SECRET: "${AUTH0_SECRET}"
      AUTH0_BASE_URL: "http://localhost:4000"
      AUTH0_CLIENT_ID: "${AUTH0_CLIENT_ID}"
      AUTH0_CLIENT_SECRET: "${AUTH0_CLIENT_SECRET}"

    depends_on:
      - position
      - data
      - kafka

volumes:
  pg-data:
  kafka: